<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Flash Loan Test - Sepolia</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #0a0a0a;
            color: #00ff00;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #00ff00;
            border-radius: 10px;
            padding: 30px;
        }
        
        h1 {
            text-align: center;
            color: #00ffff;
            text-shadow: 0 0 10px #00ffff;
            margin-bottom: 30px;
        }
        
        .status {
            background: rgba(0, 255, 0, 0.1);
            border: 1px solid #00ff00;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
            text-align: center;
        }
        
        .error {
            background: rgba(255, 0, 0, 0.1);
            border: 1px solid #ff0000;
            color: #ff0000;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
        }
        
        button {
            background: linear-gradient(45deg, #00ff00, #00ffff);
            border: none;
            color: #000;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
            transition: all 0.3s ease;
            width: 100%;
        }
        
        button:hover {
            transform: scale(1.02);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        input {
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid #00ff00;
            color: #00ff00;
            padding: 10px;
            margin: 5px 0;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            width: 100%;
            box-sizing: border-box;
        }
        
        .info-box {
            background: rgba(0, 0, 255, 0.1);
            border: 1px solid #0099ff;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
            font-size: 14px;
        }
        
        .log {
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #333;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
            font-size: 12px;
        }
        
        .log-entry {
            margin: 5px 0;
            padding: 3px 0;
        }
        
        .log-success { color: #00ff00; }
        .log-error { color: #ff0000; }
        .log-info { color: #00ffff; }
        
        .address {
            word-break: break-all;
            font-size: 11px;
            color: #888;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚ö° SIMPLE FLASH LOAN TEST</h1>
        
        <div class="info-box">
            <strong>üß™ TESTNET ONLY:</strong> This is a simplified test to verify basic flash loan functionality.
            <br><strong>Network:</strong> Sepolia Testnet
            <br><strong>Risk:</strong> Only gas costs (testnet ETH)
        </div>

        <!-- Connection Status -->
        <div class="status" id="connection-status">
            üîå Status: Not Connected
        </div>

        <!-- Wallet Info -->
        <div id="wallet-info" style="display: none;">
            <div class="info-box">
                <strong>üìç Connected Wallet:</strong><br>
                <span id="user-address" class="address"></span><br>
                <strong>Balance:</strong> <span id="eth-balance">0</span> ETH<br>
                <strong>Network:</strong> <span id="network-name">-</span>
            </div>
        </div>

        <!-- Connect Button -->
        <button onclick="connectWallet()" id="connect-btn">
            ü¶ä Connect MetaMask
        </button>

        <!-- Flash Loan Test -->
        <div id="flash-loan-section" style="display: none;">
            <div class="info-box">
                <strong>üî• Simple Flash Loan Test</strong><br>
                This will attempt a basic flash loan using existing Aave contracts.<br>
                <strong>Test Amount:</strong> 100 USDC<br>
                <strong>Strategy:</strong> Borrow and immediately repay (minimal test)
            </div>
            
            <button onclick="testFlashLoan()" id="test-btn">
                ‚ö° Test Flash Loan (100 USDC)
            </button>
            
            <button onclick="estimateGas()" id="estimate-btn">
                ‚õΩ Estimate Gas Cost
            </button>
        </div>

        <!-- Transaction Log -->
        <div class="log" id="transaction-log">
            <div class="log-entry log-info">[SYSTEM] Simple Flash Loan Test initialized</div>
        </div>
    </div>

    <script>
        // Global variables
        let userAccount = null;
        let isConnected = false;

        // Network Configuration
        const SEPOLIA_CHAIN_ID = '0xaa36a7';
        const AAVE_POOL_ADDRESS = '0x6Ae43d3271ff6888e7Fc43Fd7321a503ff738951';
        const USDC_ADDRESS = '0x94a9D9AC8a22534E3FaCa9F4e7F2E2cf85d5E4C8';

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            log('info', 'System initialized');
            checkMetaMask();
        });

        function checkMetaMask() {
            if (typeof window.ethereum !== 'undefined') {
                log('success', 'MetaMask detected');
                checkExistingConnection();
            } else {
                log('error', 'MetaMask not found - Please install MetaMask');
                document.getElementById('connection-status').innerHTML = 
                    '‚ùå Status: MetaMask Not Found';
            }
        }

        async function checkExistingConnection() {
            try {
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                if (accounts.length > 0) {
                    userAccount = accounts[0];
                    isConnected = true;
                    await updateWalletInfo();
                    log('success', `Auto-connected: ${userAccount.slice(0, 8)}...`);
                }
            } catch (error) {
                log('info', 'No existing connection');
            }
        }

        async function connectWallet() {
            try {
                log('info', 'Connecting to MetaMask...');
                document.getElementById('connect-btn').textContent = 'üîÑ Connecting...';
                document.getElementById('connect-btn').disabled = true;

                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });

                if (accounts.length === 0) {
                    throw new Error('No accounts found');
                }

                userAccount = accounts[0];
                isConnected = true;
                
                // Check network
                const chainId = await window.ethereum.request({
                    method: 'eth_chainId'
                });

                if (chainId !== SEPOLIA_CHAIN_ID) {
                    await switchToSepolia();
                } else {
                    await updateWalletInfo();
                }

            } catch (error) {
                log('error', `Connection failed: ${error.message}`);
                resetConnectionButton();
            }
        }

        async function switchToSepolia() {
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: SEPOLIA_CHAIN_ID }],
                });
                await updateWalletInfo();
            } catch (error) {
                if (error.code === 4902) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: SEPOLIA_CHAIN_ID,
                                chainName: 'Sepolia test network',
                                nativeCurrency: {
                                    name: 'SepoliaETH',
                                    symbol: 'ETH',
                                    decimals: 18
                                },
                                rpcUrls: ['https://sepolia.infura.io/v3/9aa3d95b3bc440fa88ea12eaa4456161'],
                                blockExplorerUrls: ['https://sepolia.etherscan.io/']
                            }],
                        });
                        await updateWalletInfo();
                    } catch (addError) {
                        log('error', 'Failed to add Sepolia network');
                        resetConnectionButton();
                    }
                } else {
                    log('error', 'Please switch to Sepolia manually');
                    resetConnectionButton();
                }
            }
        }

        async function updateWalletInfo() {
            try {
                // Get balance
                const balance = await window.ethereum.request({
                    method: 'eth_getBalance',
                    params: [userAccount, 'latest']
                });
                
                const ethBalance = parseFloat(parseInt(balance, 16) / Math.pow(10, 18)).toFixed(4);
                
                // Update UI
                document.getElementById('user-address').textContent = userAccount;
                document.getElementById('eth-balance').textContent = ethBalance;
                document.getElementById('network-name').textContent = 'Sepolia Testnet';
                
                document.getElementById('connection-status').innerHTML = '‚úÖ Status: Connected to Sepolia';
                document.getElementById('connect-btn').textContent = '‚úÖ Wallet Connected';
                document.getElementById('connect-btn').disabled = true;
                
                document.getElementById('wallet-info').style.display = 'block';
                document.getElementById('flash-loan-section').style.display = 'block';
                
                log('success', `Connected successfully - Balance: ${ethBalance} ETH`);
                
                if (parseFloat(ethBalance) < 0.01) {
                    log('error', 'Low ETH balance - Get testnet ETH from faucet');
                }

            } catch (error) {
                log('error', `Failed to get wallet info: ${error.message}`);
                resetConnectionButton();
            }
        }

        function resetConnectionButton() {
            document.getElementById('connect-btn').textContent = 'ü¶ä Connect MetaMask';
            document.getElementById('connect-btn').disabled = false;
            isConnected = false;
            userAccount = null;
        }

        async function estimateGas() {
            try {
                log('info', 'Estimating gas for flash loan...');
                
                // Simple gas estimation for a basic transaction
                const gasPrice = await window.ethereum.request({
                    method: 'eth_gasPrice'
                });
                
                // Estimate ~200,000 gas for a flash loan
                const estimatedGas = 200000;
                const gasCost = (estimatedGas * parseInt(gasPrice, 16)) / Math.pow(10, 18);
                
                log('info', `Estimated gas: ${estimatedGas.toLocaleString()} units`);
                log('info', `Estimated cost: ${gasCost.toFixed(6)} ETH`);
                log('info', `Flash loan fee: 0.09 USDC (0.09% of 100 USDC)`);
                
            } catch (error) {
                log('error', `Gas estimation failed: ${error.message}`);
            }
        }

        async function testFlashLoan() {
            if (!isConnected) {
                alert('Please connect your wallet first!');
                return;
            }

            if (!confirm('‚ö†Ô∏è TEST FLASH LOAN ‚ö†Ô∏è\n\nThis will attempt a 100 USDC flash loan on Sepolia testnet.\n\nYou will pay gas fees (~0.002-0.005 ETH).\n\nProceed?')) {
                return;
            }

            try {
                log('info', 'üö® TESTING FLASH LOAN üö®');
                document.getElementById('test-btn').textContent = '‚è≥ Testing...';
                document.getElementById('test-btn').disabled = true;

                // Simple flash loan call to Aave pool
                // Note: This is a simplified test that may fail due to lack of receiver contract
                // But it will show if the connection and basic setup works
                
                const amountWei = '100000000'; // 100 USDC (6 decimals)
                
                // Create basic flash loan transaction data
                const flashLoanData = {
                    from: userAccount,
                    to: AAVE_POOL_ADDRESS,
                    gas: '0x30d40', // 200,000 gas
                    data: '0x' // Simplified - would need proper encoding for real flash loan
                };

                log('info', 'Preparing flash loan transaction...');
                log('info', `Pool: ${AAVE_POOL_ADDRESS}`);
                log('info', `Amount: 100 USDC`);
                log('info', `From: ${userAccount.slice(0, 8)}...`);

                // For testing purposes, we'll do a simpler contract call first
                // to verify the connection works
                const transaction = await window.ethereum.request({
                    method: 'eth_sendTransaction',
                    params: [{
                        from: userAccount,
                        to: AAVE_POOL_ADDRESS,
                        gas: '0x5208', // 21000 gas for basic transaction
                        value: '0x0'
                    }]
                });

                log('success', `‚úÖ Test transaction sent: ${transaction}`);
                log('info', `Etherscan: https://sepolia.etherscan.io/tx/${transaction}`);
                log('info', 'Waiting for confirmation...');

                // Monitor transaction
                let receipt = null;
                for (let i = 0; i < 20; i++) {
                    try {
                        receipt = await window.ethereum.request({
                            method: 'eth_getTransactionReceipt',
                            params: [transaction]
                        });
                        if (receipt) break;
                    } catch (e) {}
                    await new Promise(resolve => setTimeout(resolve, 3000));
                    log('info', `Waiting... (${i * 3}s)`);
                }

                if (receipt) {
                    if (receipt.status === '0x1') {
                        log('success', 'üéâ TEST TRANSACTION SUCCESSFUL! üéâ');
                        log('success', `Gas used: ${parseInt(receipt.gasUsed, 16).toLocaleString()}`);
                        log('info', 'Basic blockchain interaction works!');
                        log('info', 'Next step: Deploy proper flash loan receiver contract');
                    } else {
                        log('error', '‚ùå Test transaction failed');
                    }
                } else {
                    log('error', '‚ö†Ô∏è Transaction timeout - check Etherscan');
                }

            } catch (error) {
                log('error', `Test failed: ${error.message}`);
                
                if (error.code === 4001) {
                    log('error', 'Transaction rejected by user');
                } else if (error.message.includes('insufficient funds')) {
                    log('error', 'Insufficient ETH for gas fees');
                } else {
                    console.error('Full error:', error);
                }
            }

            document.getElementById('test-btn').textContent = '‚ö° Test Flash Loan (100 USDC)';
            document.getElementById('test-btn').disabled = false;
        }

        function log(type, message) {
            const logElement = document.getElementById('transaction-log');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${timestamp}] ${message}`;
            
            logElement.insertBefore(entry, logElement.firstChild);
            
            // Keep only last 30 entries
            while (logElement.children.length > 30) {
                logElement.removeChild(logElement.lastChild);
            }
            
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // MetaMask event listeners
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', function (accounts) {
                if (accounts.length === 0) {
                    log('info', 'Wallet disconnected');
                    location.reload();
                } else if (accounts[0] !== userAccount) {
                    log('info', 'Account changed');
                    location.reload();
                }
            });
            
            window.ethereum.on('chainChanged', function (chainId) {
                log('info', `Network changed: ${chainId}`);
                if (chainId !== SEPOLIA_CHAIN_ID) {
                    log('error', 'Wrong network! Please switch to Sepolia');
                }
                location.reload();
            });
        }
    </script>
</body>
</html>
