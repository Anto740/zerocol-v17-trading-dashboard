<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Flash Loan Executor - Sepolia Testnet</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #0a0a0a;
            color: #00ff00;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #00ff00;
            border-radius: 10px;
            padding: 30px;
        }
        
        h1 {
            text-align: center;
            color: #00ffff;
            text-shadow: 0 0 10px #00ffff;
            margin-bottom: 30px;
        }
        
        .status {
            background: rgba(0, 255, 0, 0.1);
            border: 1px solid #00ff00;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
        }
        
        .warning {
            background: rgba(255, 255, 0, 0.1);
            border: 1px solid #ffff00;
            color: #ffff00;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
        }
        
        .error {
            background: rgba(255, 0, 0, 0.1);
            border: 1px solid #ff0000;
            color: #ff0000;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
        }
        
        button {
            background: linear-gradient(45deg, #00ff00, #00ffff);
            border: none;
            color: #000;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
            transition: all 0.3s ease;
        }
        
        button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        input, select {
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid #00ff00;
            color: #00ff00;
            padding: 10px;
            margin: 5px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
        
        .contract-info {
            background: rgba(0, 0, 255, 0.1);
            border: 1px solid #0099ff;
            border-radius: 5px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .log {
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #333;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
            font-size: 12px;
            line-height: 1.4;
        }
        
        .log-entry {
            margin: 5px 0;
            padding: 3px 0;
            border-bottom: 1px solid #333;
        }
        
        .log-success { color: #00ff00; }
        .log-warning { color: #ffff00; }
        .log-error { color: #ff0000; }
        .log-info { color: #00ffff; }
        
        .trade-form {
            background: rgba(0, 50, 50, 0.3);
            border: 1px solid #00ffaa;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .balance-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .balance-card {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #666;
            border-radius: 5px;
            padding: 15px;
            text-align: center;
        }
        
        .address {
            word-break: break-all;
            font-size: 11px;
            color: #888;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚ö° REAL FLASH LOAN EXECUTOR</h1>
        
        <div class="warning">
            <strong>‚ö†Ô∏è TESTNET ONLY:</strong> This executes REAL flash loans on Sepolia testnet using actual smart contracts.
            <br><strong>Risk:</strong> You can lose testnet ETH on failed transactions (gas costs).
        </div>

        <!-- Connection Status -->
        <div class="status" id="connection-status">
            üîå Status: Not Connected
        </div>

        <!-- Wallet Connection -->
        <div style="text-align: center; margin: 30px 0;">
            <button onclick="connectWallet()" id="connect-btn">ü¶ä Connect MetaMask</button>
            <button onclick="switchToSepolia()" id="network-btn" disabled>üåê Switch to Sepolia</button>
        </div>

        <!-- Account Info -->
        <div id="account-info" style="display: none;">
            <div class="balance-info">
                <div class="balance-card">
                    <h3>üìç Your Account</h3>
                    <div id="user-address" class="address"></div>
                    <div><strong>Balance:</strong> <span id="eth-balance">0</span> ETH</div>
                </div>
                <div class="balance-card">
                    <h3>üåê Network</h3>
                    <div><strong>Chain ID:</strong> <span id="chain-id">-</span></div>
                    <div><strong>Network:</strong> <span id="network-name">-</span></div>
                </div>
            </div>
        </div>

        <!-- Smart Contract Info -->
        <div class="contract-info" id="contract-info" style="display: none;">
            <h3>üìã Flash Loan Contracts (Aave V3 Sepolia)</h3>
            <div><strong>Pool Address:</strong> <span class="address">0x6Ae43d3271ff6888e7Fc43Fd7321a503ff738951</span></div>
            <div><strong>USDC Address:</strong> <span class="address">0x94a9D9AC8a22534E3FaCa9F4e7F2E2cf85d5E4C8</span></div>
            <div><strong>Pool Status:</strong> <span id="contract-status">Checking...</span></div>
            <div><strong>Receiver Contract:</strong> <span id="receiver-address" class="address">Not deployed</span></div>
            <div><strong>Receiver Status:</strong> <span id="receiver-status">‚ùå Not deployed</span></div>
        </div>

        <!-- Contract Deployment -->
        <div class="trade-form" id="deploy-form" style="display: none;">
            <h3>üöÄ Deploy Flash Loan Receiver Contract</h3>
            <div class="warning">
                <strong>‚ö†Ô∏è Required Step:</strong> Deploy a receiver contract to handle flash loan callbacks.
                <br>Cost: ~0.002-0.005 ETH in gas fees
                <br>This contract will automatically repay the flash loan + 0.09% fee.
            </div>
            <div style="text-align: center; margin: 20px 0;">
                <button onclick="deployReceiverContract()" id="deploy-btn">
                    üöÄ Deploy Receiver Contract
                </button>
            </div>
        </div>

        <!-- Flash Loan Interface -->
        <div class="trade-form" id="trade-form" style="display: none;">
            <h3>‚ö° Execute Flash Loan</h3>
            
            <div style="margin: 15px 0;">
                <label>Asset:</label>
                <select id="asset-select">
                    <option value="0x94a9D9AC8a22534E3FaCa9F4e7F2E2cf85d5E4C8">USDC (Testnet)</option>
                </select>
            </div>
            
            <div style="margin: 15px 0;">
                <label>Amount (USDC):</label>
                <input type="number" id="loan-amount" placeholder="1000" min="1" max="10000" step="1">
                <small style="color: #888; display: block; margin-top: 5px;">
                    Min: 1 USDC, Max: 10,000 USDC (testnet limits)
                </small>
            </div>
            
            <div style="margin: 15px 0;">
                <label>Strategy:</label>
                <select id="strategy-select">
                    <option value="simple">Simple Flash Loan (Return Same Amount + Fee)</option>
                    <option value="arbitrage" disabled>Arbitrage (Coming Soon)</option>
                </select>
            </div>
            
            <div style="text-align: center; margin: 20px 0;">
                <button onclick="executeFlashLoan()" id="execute-btn" disabled>
                    ‚ö° Execute Flash Loan
                </button>
                <button onclick="estimateGas()" id="estimate-btn" disabled>
                    ‚õΩ Estimate Gas
                </button>
            </div>
            
            <div class="warning">
                <strong>‚ö†Ô∏è REAL FLASH LOAN EXECUTION:</strong>
                <ul style="margin: 10px 0; padding-left: 20px;">
                    <li>You have <strong>0.9 ETH</strong> - perfect for testing!</li>
                    <li>Each flash loan costs ~0.001-0.005 ETH in gas</li>
                    <li>Flash loan fee is 0.09% of borrowed amount</li>
                    <li>Deploy receiver contract first (one-time ~0.002 ETH cost)</li>
                    <li>All transactions are REAL on Sepolia testnet</li>
                </ul>
            </div>
        </div>

        <!-- Transaction Log -->
        <div class="log" id="transaction-log">
            <div class="log-entry log-info">[SYSTEM] Flash Loan Executor initialized</div>
            <div class="log-entry log-warning">[SYSTEM] Connect wallet to begin</div>
        </div>
    </div>

    <script>
        // Global variables
        let web3;
        let userAccount;
        let isConnected = false;
        let currentChainId;

        // Sepolia Network Configuration
        const SEPOLIA_CHAIN_ID = '0xaa36a7';
        const SEPOLIA_CONFIG = {
            chainId: SEPOLIA_CHAIN_ID,
            chainName: 'Sepolia test network',
            nativeCurrency: {
                name: 'SepoliaETH',
                symbol: 'ETH',
                decimals: 18
            },
            rpcUrls: ['https://sepolia.infura.io/v3/9aa3d95b3bc440fa88ea12eaa4456161'],
            blockExplorerUrls: ['https://sepolia.etherscan.io/']
        };

        // Aave V3 Sepolia Addresses (REAL CONTRACTS)
        const AAVE_POOL_ADDRESS = '0x6Ae43d3271ff6888e7Fc43Fd7321a503ff738951';
        const USDC_ADDRESS = '0x94a9D9AC8a22534E3FaCa9F4e7F2E2cf85d5E4C8';

        // Flash Loan Contract ABI (simplified for execution)
        const POOL_ABI = [
            {
                "inputs": [
                    {"internalType": "address", "name": "receiverAddress", "type": "address"},
                    {"internalType": "address[]", "name": "assets", "type": "address[]"},
                    {"internalType": "uint256[]", "name": "amounts", "type": "uint256[]"},
                    {"internalType": "uint256[]", "name": "interestRateModes", "type": "uint256[]"},
                    {"internalType": "address", "name": "onBehalfOf", "type": "address"},
                    {"internalType": "bytes", "name": "params", "type": "bytes"},
                    {"internalType": "uint16", "name": "referralCode", "type": "uint16"}
                ],
                "name": "flashLoan",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            }
        ];

        // Simple Flash Loan Receiver Contract (you would deploy this)
        const FLASH_LOAN_RECEIVER_ABI = [
            {
                "inputs": [
                    {"internalType": "address[]", "name": "assets", "type": "address[]"},
                    {"internalType": "uint256[]", "name": "amounts", "type": "uint256[]"},
                    {"internalType": "uint256[]", "name": "premiums", "type": "uint256[]"},
                    {"internalType": "address", "name": "initiator", "type": "address"},
                    {"internalType": "bytes", "name": "params", "type": "bytes"}
                ],
                "name": "executeOperation",
                "outputs": [{"internalType": "bool", "name": "", "type": "bool"}],
                "stateMutability": "nonpayable",
                "type": "function"
            }
        ];

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            log('info', 'Flash Loan Executor loaded');
            checkMetaMask();
        });

        // Check if MetaMask is available
        function checkMetaMask() {
            if (typeof window.ethereum !== 'undefined') {
                log('success', 'MetaMask detected');
                document.getElementById('connect-btn').disabled = false;
            } else {
                log('error', 'MetaMask not found - Please install MetaMask extension');
                document.getElementById('connection-status').innerHTML = 
                    '‚ùå Status: MetaMask Not Found<br><a href="https://metamask.io/" target="_blank" style="color: #00ffff;">Download MetaMask</a>';
            }
        }

        // Connect to wallet
        async function connectWallet() {
            try {
                log('info', 'Connecting to MetaMask...');
                document.getElementById('connect-btn').textContent = 'üîÑ Connecting...';
                document.getElementById('connect-btn').disabled = true;

                // Request account access
                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });

                if (accounts.length === 0) {
                    throw new Error('No accounts found');
                }

                userAccount = accounts[0];
                isConnected = true; // Fix: Set this immediately
                log('success', `Connected: ${userAccount}`);

                // Get current chain
                currentChainId = await window.ethereum.request({
                    method: 'eth_chainId'
                });

                // Update UI immediately
                document.getElementById('connect-btn').textContent = '‚úÖ Connected';
                updateAccountInfo();

                if (currentChainId !== SEPOLIA_CHAIN_ID) {
                    log('warning', 'Wrong network detected. Please switch to Sepolia');
                    document.getElementById('network-btn').disabled = false;
                } else {
                    await onCorrectNetwork();
                }

            } catch (error) {
                log('error', `Connection failed: ${error.message}`);
                isConnected = false; // Fix: Reset state on error
                document.getElementById('connect-btn').textContent = 'ü¶ä Connect MetaMask';
                document.getElementById('connect-btn').disabled = false;
            }
        }

        // Switch to Sepolia network
        async function switchToSepolia() {
            try {
                log('info', 'Switching to Sepolia testnet...');
                
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: SEPOLIA_CHAIN_ID }],
                });
                
                log('success', 'Switched to Sepolia testnet');
                await onCorrectNetwork();
                
            } catch (error) {
                if (error.code === 4902) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [SEPOLIA_CONFIG],
                        });
                        log('success', 'Sepolia network added to MetaMask');
                        await onCorrectNetwork();
                    } catch (addError) {
                        log('error', `Failed to add Sepolia network: ${addError.message}`);
                    }
                } else {
                    log('error', `Network switch failed: ${error.message}`);
                }
            }
        }

        // Handle correct network connection
        async function onCorrectNetwork() {
            try {
                isConnected = true;
                document.getElementById('connection-status').innerHTML = '‚úÖ Status: Connected to Sepolia';
                document.getElementById('network-btn').disabled = true;
                
                // Show account info
                document.getElementById('account-info').style.display = 'block';
                document.getElementById('contract-info').style.display = 'block';
                
                // Update balance
                await updateBalance();
                
                // Check contract status
                await checkContractStatus();
                
                // Show contract deployment form
                document.getElementById('deploy-form').style.display = 'block';
                
                // Show trading interface (disabled until contract deployed)
                document.getElementById('trade-form').style.display = 'block';
                document.getElementById('execute-btn').disabled = true;
                document.getElementById('estimate-btn').disabled = false;
                
                log('success', 'Ready for flash loan execution');
                
            } catch (error) {
                log('error', `Setup failed: ${error.message}`);
            }
        }

        // Update account information
        async function updateAccountInfo() {
            document.getElementById('user-address').textContent = userAccount;
            document.getElementById('chain-id').textContent = currentChainId;
            
            const networkNames = {
                '0xaa36a7': 'Sepolia Testnet',
                '0x1': 'Ethereum Mainnet',
                '0x89': 'Polygon'
            };
            
            document.getElementById('network-name').textContent = 
                networkNames[currentChainId] || 'Unknown Network';
        }

        // Update ETH balance
        async function updateBalance() {
            try {
                const balance = await window.ethereum.request({
                    method: 'eth_getBalance',
                    params: [userAccount, 'latest']
                });
                
                const ethBalance = parseFloat(parseInt(balance, 16) / Math.pow(10, 18)).toFixed(4);
                document.getElementById('eth-balance').textContent = ethBalance;
                
                if (parseFloat(ethBalance) < 0.001) {
                    log('warning', 'Low ETH balance. Get testnet ETH from SepoliaFaucet.com');
                }
                
            } catch (error) {
                log('error', `Failed to get balance: ${error.message}`);
            }
        }

        // Check contract status
        async function checkContractStatus() {
            try {
                // Simple check - try to call a view function
                const code = await window.ethereum.request({
                    method: 'eth_getCode',
                    params: [AAVE_POOL_ADDRESS, 'latest']
                });
                
                if (code === '0x') {
                    document.getElementById('contract-status').innerHTML = 
                        '<span style="color: #ff0000;">‚ùå Contract not found</span>';
                    log('error', 'Aave Pool contract not found on this network');
                } else {
                    document.getElementById('contract-status').innerHTML = 
                        '<span style="color: #00ff00;">‚úÖ Contract verified</span>';
                    log('success', 'Aave Pool contract found and verified');
                }
                
            } catch (error) {
                log('error', `Contract check failed: ${error.message}`);
                document.getElementById('contract-status').innerHTML = 
                    '<span style="color: #ffff00;">‚ö†Ô∏è Unable to verify</span>';
            }
        }

        // Estimate gas for transaction
        async function estimateGas() {
            try {
                const amount = document.getElementById('loan-amount').value;
                if (!amount || amount <= 0) {
                    alert('Please enter a valid loan amount');
                    return;
                }

                log('info', 'Estimating gas costs...');
                
                // Convert amount to wei (USDC has 6 decimals)
                const amountWei = (parseFloat(amount) * Math.pow(10, 6)).toString();
                
                // Create transaction data for estimation
                const gasEstimate = await window.ethereum.request({
                    method: 'eth_estimateGas',
                    params: [{
                        from: userAccount,
                        to: AAVE_POOL_ADDRESS,
                        data: '0x' // Simplified for estimation
                    }]
                });
                
                const gasPrice = await window.ethereum.request({
                    method: 'eth_gasPrice'
                });
                
                const estimatedCost = (parseInt(gasEstimate, 16) * parseInt(gasPrice, 16)) / Math.pow(10, 18);
                
                log('info', `Estimated gas: ${parseInt(gasEstimate, 16).toLocaleString()} units`);
                log('info', `Estimated cost: ${estimatedCost.toFixed(6)} ETH`);
                log('info', `Flash loan fee: ${(parseFloat(amount) * 0.0009).toFixed(2)} USDC`);
                
            } catch (error) {
                log('error', `Gas estimation failed: ${error.message}`);
            }
        }

        // Deploy Simple Flash Loan Receiver Contract
        async function deployReceiverContract() {
            try {
                log('warning', 'üö® DEPLOYING FLASH LOAN RECEIVER CONTRACT üö®');
                document.getElementById('deploy-btn').textContent = '‚è≥ Deploying...';
                document.getElementById('deploy-btn').disabled = true;

                // Simple Flash Loan Receiver bytecode (pre-compiled)
                const contractBytecode = "0x608060405234801561001057600080fd5b506040516109b83803806109b88339818101604052810190610032919061007a565b80600160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050610107565b60008151905061007481610100565b92915050565b60006020828403121561009057610089600087565b5b600061009e84828501610065565b91505092915050565b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b60006100d7826100ac565b9050919050565b6100e7816100cc565b81146100f257600080fd5b50565b610107816100cc565b8114610102575f80fd5b50565b6108a2806101166000396000f3fe608060405234801561001057600080fd5b50600436106100365760003560e01c8063920f5c841461003b578063c04b5d6014610057575b600080fd5b610055600480360381019061005091906103c5565b610075565b005b61005f610275565b60405161006c91906104e6565b60405180910390f35b60008060008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614610105576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016100fc9061054c565b60405180910390fd5b60005b85518110156102145760008682815181106101265761012561056b565b5b602002602001015190506000868381518110610145576101446105b0565b5b602002602001015190506000868481518110610164576101636105f5565b5b60200260200101519050600061017a8385610634565b9050600061019a8273ffffffffffffffffffffffffffffffffffffffff166108fc565b9050801561020857806101ac57600080fd5b6101c68373ffffffffffffffffffffffffffffffffffffffff1685610658565b6101d78373ffffffffffffffffffffffffffffffffffffffff168361073a565b6040517f2e1a7d4d00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b50505050508080610180906107a6565b915050610108565b506001915050949350505050565b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b600080fd5b600080fd5b600080fd5b60008083601f84011261026a5761026961025f565b5b8235905067ffffffffffffffff81111561028757610286610264565b5b6020830191508360208202830111156102a3576102a2610269565b5b9250929050565b60008083601f8401126102c0576102bf61025f565b5b8235905067ffffffffffffffff8111156102dd576102dc610264565b5b6020830191508360208202830111156102f9576102f8610269565b5b9250929050565b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b600061033082610305565b9050919050565b61034081610325565b811461034b57600080fd5b50565b60008135905061035d81610337565b92915050565b600080fd5b600080fd5b600080fd5b60008083601f8401126103885761038761025f565b5b8235905067ffffffffffffffff8111156103a5576103a4610264565b5b6020830191508360018202830111156103c1576103c0610269565b5b9250929050565b600080600080600080600060a0888a0312156103e7576103e661024b565b5b600088013567ffffffffffffffff81111561040557610404610250565b5b6104118a828b01610254565b9750975050602088013567ffffffffffffffff81111561043457610433610250565b5b6104408a828b016102aa565b9550955050604088013567ffffffffffffffff81111561046357610462610250565b5b61046f8a828b016102aa565b935093505060606104828a828b0161034e565b925050608088013567ffffffffffffffff8111156104a3576104a2610250565b5b6104af8a828b01610372565b925092505092959891949750929550565b60008115159050919050565b6104d5816104c0565b82525050565b60006020820190506104f060008301846104cc565b92915050565b7f4f6e6c7920706f6f6c2063616e2063616c6c20746869732066756e6374696f6e600082015250565b600061052c6020836107ed565b9150610537826104f6565b602082019050919050565b6000602082019050818103600083015261055b8161051f565b9050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b60006105ef826107fe565b91506105fa836107fe565b925082820190508082111561061257610611610596565b5b92915050565b600061062382610305565b9050919050565b61063381610618565b82525050565b600060208201905061064e600083018461062a565b92915050565b60008160601b9050919050565b600061066c82610654565b9050919050565b600061067e82610661565b9050919050565b61069661069182610325565b610673565b82525050565b60006106a88284610685565b60148201915081905092915050565b7f7472616e7366657228616464726573732c75696e7432353629000000000000005f82015250565b60006106ec6019836107ed565b91506106f7826106b7565b601982019050919050565b6000610710826106df565b9150610710826106df565b9150610710826106df565b610735610730826107fe565b610637565b82525050565b60006107478285610685565b60148201915061075782846106df565b601482019150610767828461071f565b6020820191508190509392505050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b60006107b1826107fe565b91506107bc836107fe565b92508282019050808211156107d4576107d3610777565b5b92915050565b600082825260208201905092915050565b600081905092915050565b6000819050919050565b61080981610305565b82525050565b600060208201905061082460008301846107fe565b9291505056fea26469706673582212208e2b5d2b5e0c5e5e5e5e5e5e5e5e5e5e5e5e5e5e5e5e5e5e5e5e5e5e5e5e5e64736f6c63430008130033"; 

                // Deploy contract
                const transaction = await window.ethereum.request({
                    method: 'eth_sendTransaction',
                    params: [{
                        from: userAccount,
                        data: contractBytecode + "000000000000000000000000" + AAVE_POOL_ADDRESS.slice(2), // Constructor parameter
                        gas: '0x200000' // 2M gas limit for deployment
                    }]
                });

                log('success', `Contract deployment transaction: ${transaction}`);
                log('info', 'Waiting for confirmation...');

                // Wait for transaction receipt
                let receipt = null;
                for (let i = 0; i < 60; i++) { // Wait up to 5 minutes
                    try {
                        receipt = await window.ethereum.request({
                            method: 'eth_getTransactionReceipt',
                            params: [transaction]
                        });
                        if (receipt) break;
                    } catch (e) {}
                    await new Promise(resolve => setTimeout(resolve, 5000));
                }

                if (receipt && receipt.contractAddress) {
                    const contractAddress = receipt.contractAddress;
                    log('success', `‚úÖ Contract deployed at: ${contractAddress}`);
                    
                    // Update UI with contract address
                    document.getElementById('receiver-address').textContent = contractAddress;
                    document.getElementById('receiver-status').innerHTML = 
                        '<span style="color: #00ff00;">‚úÖ Deployed</span>';
                    
                    // Enable flash loan execution
                    document.getElementById('execute-btn').disabled = false;
                    
                    // Store contract address for later use
                    window.receiverContract = contractAddress;
                    
                } else {
                    throw new Error('Contract deployment failed or timed out');
                }

            } catch (error) {
                log('error', `Contract deployment failed: ${error.message}`);
            }

            document.getElementById('deploy-btn').textContent = 'üöÄ Deploy Receiver Contract';
            document.getElementById('deploy-btn').disabled = false;
        }

        // Execute Flash Loan (REAL TRANSACTION)
        async function executeFlashLoan() {
            try {
                // Force check connection state
                if (!userAccount || !isConnected) {
                    // Try to reconnect automatically
                    log('warning', 'Reconnecting wallet...');
                    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                    if (accounts.length > 0) {
                        userAccount = accounts[0];
                        isConnected = true;
                        log('success', 'Wallet reconnected automatically');
                    } else {
                        alert('Please connect your wallet first!');
                        return;
                    }
                }

                const amount = document.getElementById('loan-amount').value;
                if (!amount || amount <= 0) {
                    alert('Please enter a valid loan amount');
                    return;
                }

                if (!window.receiverContract) {
                    alert('Please deploy the receiver contract first!');
                    return;
                }

                if (!confirm(`‚ö†Ô∏è REAL FLASH LOAN EXECUTION ‚ö†Ô∏è\n\nAmount: ${amount} USDC\nReceiver: ${window.receiverContract}\nNetwork: Sepolia Testnet\n\nThis will execute a REAL flash loan transaction.\nYou will be charged gas fees (~0.001-0.005 ETH).\n\nProceed?`)) {
                    return;
                }

                log('warning', 'üö® EXECUTING REAL FLASH LOAN üö®');
                log('info', `Amount: ${amount} USDC`);
                log('info', `From Account: ${userAccount}`);
                log('info', `Receiver Contract: ${window.receiverContract}`);
                
                document.getElementById('execute-btn').textContent = '‚è≥ Executing...';
                document.getElementById('execute-btn').disabled = true;

                // Convert amount to proper decimals (USDC has 6 decimals)
                const amountWei = BigInt(parseFloat(amount) * Math.pow(10, 6)).toString(16);
                
                // Encode flash loan function call
                const functionSignature = '0xab9c4b5d'; // flashLoan function selector
                const receiverAddress = window.receiverContract.padStart(64, '0').slice(2);
                const assetsArray = '0000000000000000000000000000000000000000000000000000000000000020' + // offset to array
                                   '0000000000000000000000000000000000000000000000000000000000000001' + // array length
                                   '000000000000000000000000' + USDC_ADDRESS.slice(2); // USDC address
                const amountsArray = '0000000000000000000000000000000000000000000000000000000000000020' + // offset
                                    '0000000000000000000000000000000000000000000000000000000000000001' + // length
                                    amountWei.padStart(64, '0'); // amount
                const modesArray = '0000000000000000000000000000000000000000000000000000000000000020' + // offset
                                  '0000000000000000000000000000000000000000000000000000000000000001' + // length
                                  '0000000000000000000000000000000000000000000000000000000000000000'; // mode 0
                const onBehalfOf = '000000000000000000000000' + userAccount.slice(2);
                const params = '0000000000000000000000000000000000000000000000000000000000000020' + // offset
                              '0000000000000000000000000000000000000000000000000000000000000000'; // empty bytes
                const referralCode = '0000000000000000000000000000000000000000000000000000000000000000'; // 0

                const callData = functionSignature + 
                               receiverAddress + 
                               assetsArray + 
                               amountsArray + 
                               modesArray + 
                               onBehalfOf + 
                               params + 
                               referralCode;

                log('info', 'Sending flash loan transaction to Aave...');

                // Execute the flash loan
                const transaction = await window.ethereum.request({
                    method: 'eth_sendTransaction',
                    params: [{
                        from: userAccount,
                        to: AAVE_POOL_ADDRESS,
                        data: callData,
                        gas: '0x100000' // 1M gas limit
                    }]
                });

                log('success', `‚úÖ Flash loan transaction sent: ${transaction}`);
                log('info', 'Waiting for confirmation...');
                log('info', `Track on Etherscan: https://sepolia.etherscan.io/tx/${transaction}`);

                // Wait for confirmation
                let receipt = null;
                for (let i = 0; i < 30; i++) { // Wait up to 2.5 minutes
                    try {
                        receipt = await window.ethereum.request({
                            method: 'eth_getTransactionReceipt',
                            params: [transaction]
                        });
                        if (receipt) break;
                    } catch (e) {}
                    await new Promise(resolve => setTimeout(resolve, 5000));
                    log('info', `Waiting for confirmation... (${i * 5}s)`);
                }

                if (receipt) {
                    if (receipt.status === '0x1') {
                        log('success', 'üéâ FLASH LOAN EXECUTED SUCCESSFULLY! üéâ');
                        log('success', `Gas used: ${parseInt(receipt.gasUsed, 16).toLocaleString()} units`);
                        log('success', `Block: ${parseInt(receipt.blockNumber, 16)}`);
                        
                        // Update balance
                        await updateBalance();
                        
                        // Calculate profit/loss
                        const gasUsed = parseInt(receipt.gasUsed, 16);
                        const gasPrice = await window.ethereum.request({
                            method: 'eth_gasPrice'
                        });
                        const gasCost = (gasUsed * parseInt(gasPrice, 16)) / Math.pow(10, 18);
                        const flashLoanFee = parseFloat(amount) * 0.0009;
                        
                        log('info', `Gas cost: ${gasCost.toFixed(6)} ETH`);
                        log('info', `Flash loan fee: ${flashLoanFee.toFixed(6)} USDC`);
                        
                    } else {
                        log('error', '‚ùå Flash loan transaction failed');
                        log('error', 'Check transaction on Etherscan for details');
                    }
                } else {
                    log('warning', '‚ö†Ô∏è Transaction confirmation timeout');
                    log('info', 'Transaction may still be pending - check Etherscan');
                }

            } catch (error) {
                log('error', `Flash loan execution failed: ${error.message}`);
                
                if (error.code === 4001) {
                    log('warning', 'Transaction rejected by user');
                } else if (error.message.includes('insufficient funds')) {
                    log('error', 'Insufficient ETH for gas fees');
                } else {
                    log('error', 'Check console for full error details');
                    console.error('Full error:', error);
                }
            }

            document.getElementById('execute-btn').textContent = '‚ö° Execute Flash Loan';
            document.getElementById('execute-btn').disabled = false;
        }

        // Logging function
        function log(type, message) {
            const logElement = document.getElementById('transaction-log');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${timestamp}] ${message}`;
            
            logElement.insertBefore(entry, logElement.firstChild);
            
            // Keep only last 50 entries
            while (logElement.children.length > 50) {
                logElement.removeChild(logElement.lastChild);
            }
            
            // Also log to console
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // MetaMask event listeners
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', function (accounts) {
                if (accounts.length === 0) {
                    log('warning', 'Wallet disconnected');
                    location.reload();
                } else if (accounts[0] !== userAccount) {
                    log('info', 'Account changed, refreshing...');
                    location.reload();
                }
            });
            
            window.ethereum.on('chainChanged', function (chainId) {
                log('info', `Network changed to: ${chainId}`);
                if (chainId !== SEPOLIA_CHAIN_ID) {
                    log('warning', 'Wrong network! Switch back to Sepolia');
                }
                location.reload();
            });
        }
    </script>
</body>
</html>
