<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ML Flash Loan Prediction System - Antoni0's AI</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
            color: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .header {
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            border-bottom: 2px solid #00d4ff;
            padding: 20px 0;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }
        
        .logo h1 {
            font-size: 32px;
            font-weight: 800;
            background: linear-gradient(45deg, #00d4ff, #00ff88, #ff6b6b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 20px;
        }
        
        .banner {
            background: linear-gradient(45deg, rgba(255, 165, 0, 0.15), rgba(255, 69, 0, 0.15));
            border: 2px solid #ff6b35;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .card {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 20px;
            padding: 25px;
            transition: all 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 212, 255, 0.2);
        }
        
        .card h3 {
            color: #00d4ff;
            margin-bottom: 20px;
            font-size: 20px;
        }
        
        .ml-section {
            background: linear-gradient(45deg, rgba(147, 51, 234, 0.2), rgba(236, 72, 153, 0.2));
            border: 2px solid #a855f7;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
        }
        
        .ml-brain {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .brain-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(45deg, #a855f7, #ec4899);
            border-radius: 50%;
            animation: thinking 3s ease-in-out infinite;
        }
        
        @keyframes thinking {
            0%, 100% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.1) rotate(90deg); }
            50% { transform: scale(1.2) rotate(180deg); }
            75% { transform: scale(1.1) rotate(270deg); }
        }
        
        .prediction-card {
            background: linear-gradient(45deg, rgba(0, 255, 136, 0.1), rgba(0, 212, 255, 0.1));
            border: 2px solid;
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .prediction-card.high-confidence {
            border-color: #00ff88;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
        }
        
        .prediction-card.medium-confidence {
            border-color: #ffd700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }
        
        .prediction-card.low-confidence {
            border-color: #ff6b6b;
            box-shadow: 0 0 20px rgba(255, 107, 107, 0.3);
        }
        
        .prediction-card:hover {
            transform: scale(1.02);
        }
        
        .prediction-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-top: 15px;
        }
        
        .stat-box {
            text-align: center;
            padding: 10px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
        }
        
        .stat-value {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .trading-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
            flex-wrap: wrap;
        }
        
        .control-btn {
            background: linear-gradient(45deg, #00d4ff, #00ff88);
            border: none;
            color: #000;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: 700;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 212, 255, 0.4);
        }
        
        .control-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 212, 255, 0.6);
        }
        
        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .control-btn.danger {
            background: linear-gradient(45deg, #ff6b6b, #ff4757);
            color: white;
        }
        
        .profit-tracker {
            background: linear-gradient(45deg, rgba(0, 255, 136, 0.1), rgba(0, 212, 255, 0.1));
            border: 2px solid #00ff88;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
        }
        
        .profit-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .profit-card {
            background: rgba(0, 0, 0, 0.6);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .profit-amount {
            font-size: 24px;
            font-weight: 800;
            margin-bottom: 10px;
        }
        
        .profit-positive { color: #00ff88; }
        .profit-negative { color: #ff6b6b; }
        .profit-neutral { color: #ffd700; }
        
        .learning-feed {
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #333;
            border-radius: 15px;
            padding: 20px;
            margin-top: 30px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .feed-item {
            margin: 10px 0;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.5;
            animation: feedSlide 0.5s ease-out;
        }
        
        @keyframes feedSlide {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .feed-success {
            background: rgba(0, 255, 136, 0.1);
            border-left: 4px solid #00ff88;
        }
        
        .feed-failure {
            background: rgba(255, 107, 107, 0.1);
            border-left: 4px solid #ff6b6b;
        }
        
        .feed-learning {
            background: rgba(147, 51, 234, 0.1);
            border-left: 4px solid #a855f7;
        }
        
        .connect-section {
            text-align: center;
            padding: 40px;
            background: rgba(0, 212, 255, 0.1);
            border: 2px solid #00d4ff;
            border-radius: 20px;
            margin-bottom: 30px;
        }
        
        .wallet-info {
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid #00ff88;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .address { 
            font-family: 'Courier New', monospace; 
            word-break: break-all; 
            font-size: 12px; 
            opacity: 0.8; 
        }
        
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .prediction-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .trading-controls {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo">
                <h1>üß† Antoni0's ML Flash Loan AI</h1>
            </div>
            <div style="display: flex; align-items: center; gap: 15px;">
                <div style="color: #00ff88; font-weight: 600;">
                    <span id="connection-status">üî¥ Disconnected</span>
                </div>
            </div>
        </div>
    </div>

    <div class="main-container">
        <!-- Banner -->
        <div class="banner">
            <h2>üöÄ REAL FLASH LOAN PREDICTION SYSTEM</h2>
            <p>Machine Learning powered arbitrage detection with real profit/loss tracking on Sepolia testnet</p>
        </div>

        <!-- Connection Section -->
        <div class="connect-section" id="connect-section">
            <h2>üîó Connect to Start ML-Powered Trading</h2>
            <p>Connect your MetaMask wallet to access the AI prediction system</p>
            <button class="control-btn" onclick="connectWallet()" id="connect-btn">
                ü¶ä Connect MetaMask
            </button>
        </div>

        <!-- Wallet Info -->
        <div class="wallet-info" id="wallet-info" style="display: none;">
            <h3>üìç Connected Wallet</h3>
            <div><strong>Address:</strong> <span id="user-address" class="address"></span></div>
            <div><strong>Balance:</strong> <span id="eth-balance">0</span> ETH</div>
            <div><strong>Network:</strong> <span id="network-name">Sepolia Testnet</span></div>
        </div>

        <!-- Main Dashboard -->
        <div id="main-dashboard" style="display: none;">
            
            <!-- ML Brain Section -->
            <div class="ml-section">
                <div class="ml-brain">
                    <div class="brain-icon"></div>
                    <div>
                        <h2>üß† AI Prediction Engine</h2>
                        <p>Advanced ML algorithms analyzing market conditions, gas prices, liquidity, and historical success rates</p>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                    <div class="stat-box">
                        <div class="stat-value" style="color: #a855f7;" id="ml-accuracy">--</div>
                        <div class="stat-label">Model Accuracy</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" style="color: #00ff88;" id="predictions-made">0</div>
                        <div class="stat-label">Predictions Made</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" style="color: #ffd700;" id="learning-rate">Active</div>
                        <div class="stat-label">Learning Status</div>
                    </div>
                </div>
            </div>

            <!-- Profit Tracker -->
            <div class="profit-tracker">
                <h3>üí∞ Real-Time P&L Tracking</h3>
                <div class="profit-display">
                    <div class="profit-card">
                        <div class="profit-amount profit-neutral" id="total-profit">$0.00</div>
                        <div>Total Profit/Loss</div>
                    </div>
                    <div class="profit-card">
                        <div class="profit-amount" style="color: #00d4ff;" id="successful-trades">0</div>
                        <div>Successful Trades</div>
                    </div>
                    <div class="profit-card">
                        <div class="profit-amount" style="color: #ff6b6b;" id="failed-trades">0</div>
                        <div>Failed Trades</div>
                    </div>
                    <div class="profit-card">
                        <div class="profit-amount" style="color: #ffd700;" id="win-rate">--</div>
                        <div>Win Rate</div>
                    </div>
                </div>
            </div>

            <!-- Dashboard Grid -->
            <div class="dashboard-grid">
                <!-- Live Predictions -->
                <div class="card">
                    <h3>üéØ Live ML Predictions</h3>
                    <div id="predictions-container">
                        <div style="text-align: center; padding: 40px; opacity: 0.6;">
                            üîÑ AI scanning for opportunities...
                        </div>
                    </div>
                </div>

                <!-- Market Analysis -->
                <div class="card">
                    <h3>üìä Market Analysis</h3>
                    <div id="market-analysis">
                        <div class="stat-box" style="margin-bottom: 15px;">
                            <div class="stat-value" style="color: #00ff88;" id="gas-price">-- Gwei</div>
                            <div class="stat-label">Current Gas Price</div>
                        </div>
                        <div class="stat-box" style="margin-bottom: 15px;">
                            <div class="stat-value" style="color: #ffd700;" id="market-volatility">--</div>
                            <div class="stat-label">Market Volatility</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" style="color: #00d4ff;" id="liquidity-score">--</div>
                            <div class="stat-label">Liquidity Score</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trading Controls -->
            <div class="trading-controls">
                <button class="control-btn" onclick="startAITrading()" id="ai-trading-btn">
                    üöÄ Start AI Trading
                </button>
                <button class="control-btn" onclick="scanMarket()" id="scan-btn">
                    üîç Force Market Scan
                </button>
                <button class="control-btn danger" onclick="stopTrading()" id="stop-btn">
                    ‚èπÔ∏è Emergency Stop
                </button>
            </div>

            <!-- Learning Feed -->
            <div class="learning-feed">
                <h3 style="margin-bottom: 20px;">üß† AI Learning Feed</h3>
                <div id="learning-feed-content">
                    <div class="feed-item feed-learning">
                        [SYSTEM] ML Flash Loan Prediction System initialized
                    </div>
                    <div class="feed-item feed-learning">
                        [AI] Loading historical flash loan data for training...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global State
        let isConnected = false;
        let userAccount = null;
        let aiTradingActive = false;
        let mlModel = null;
        
        // Trading Statistics
        let tradingStats = {
            totalProfit: 0,
            totalTrades: 0,
            successfulTrades: 0,
            failedTrades: 0,
            startingBalance: 0,
            currentBalance: 0,
            gasCosts: 0,
            predictionsMade: 0,
            modelAccuracy: 0
        };

        // ML Prediction Model (Simplified)
        class FlashLoanPredictor {
            constructor() {
                this.accuracy = 0.65; // Starting accuracy
                this.predictions = [];
                this.learningData = [];
            }

            analyzeOpportunity(opportunity) {
                // Simulate ML analysis factors
                const factors = {
                    gasPrice: this.getGasScore(opportunity.gasPrice),
                    liquiditySpread: this.getLiquidityScore(opportunity.spread),
                    marketVolatility: this.getVolatilityScore(),
                    historicalSuccess: this.getHistoricalScore(opportunity.pair),
                    timingFactor: this.getTimingScore(),
                    competitionLevel: this.getCompetitionScore()
                };

                // Weighted prediction algorithm
                const prediction = (
                    factors.gasPrice * 0.25 +
                    factors.liquiditySpread * 0.20 +
                    factors.marketVolatility * 0.15 +
                    factors.historicalSuccess * 0.15 +
                    factors.timingFactor * 0.15 +
                    factors.competitionLevel * 0.10
                );

                const confidence = Math.min(prediction * this.accuracy, 0.95);
                
                return {
                    confidence: confidence,
                    recommendation: confidence > 0.7 ? 'EXECUTE' : confidence > 0.5 ? 'CAUTION' : 'SKIP',
                    factors: factors,
                    reasoning: this.generateReasoning(factors, confidence)
                };
            }

            getGasScore(gasPrice) {
                // Lower gas = higher score
                const normalizedGas = Math.max(0, Math.min(1, (50 - gasPrice) / 50));
                return normalizedGas;
            }

            getLiquidityScore(spread) {
                // Higher spread = higher score (more profit potential)
                return Math.min(1, spread / 1000);
            }

            getVolatilityScore() {
                // Medium volatility is optimal
                const volatility = Math.random() * 0.1 + 0.05; // 5-15%
                return volatility < 0.08 ? volatility / 0.08 : (0.15 - volatility) / 0.07;
            }

            getHistoricalScore(pair) {
                // Simulate historical success rates for different pairs
                const pairScores = {
                    'ETH/USDC': 0.75,
                    'BTC/USDT': 0.68,
                    'LINK/ETH': 0.60,
                    'UNI/USDC': 0.55,
                    'AAVE/ETH': 0.70
                };
                return pairScores[pair] || 0.60;
            }

            getTimingScore() {
                // Time of day affects success rate
                const hour = new Date().getHours();
                // Peak hours (9-11 AM, 2-4 PM UTC) have higher competition
                if ((hour >= 9 && hour <= 11) || (hour >= 14 && hour <= 16)) {
                    return 0.4; // High competition
                } else {
                    return 0.8; // Better timing
                }
            }

            getCompetitionScore() {
                // Simulate MEV bot competition
                return Math.random() * 0.6 + 0.2; // 20-80%
            }

            generateReasoning(factors, confidence) {
                let reasoning = [];
                
                if (factors.gasPrice > 0.7) reasoning.push("‚úÖ Low gas environment");
                else if (factors.gasPrice < 0.3) reasoning.push("‚ùå High gas costs");
                
                if (factors.liquiditySpread > 0.6) reasoning.push("‚úÖ High profit spread");
                else reasoning.push("‚ö†Ô∏è Limited profit margin");
                
                if (factors.marketVolatility > 0.6) reasoning.push("‚úÖ Optimal volatility");
                else reasoning.push("‚ö†Ô∏è Low volatility conditions");
                
                if (factors.historicalSuccess > 0.7) reasoning.push("‚úÖ Strong historical performance");
                
                if (factors.competitionLevel < 0.4) reasoning.push("‚ùå High MEV competition");
                else if (factors.competitionLevel > 0.7) reasoning.push("‚úÖ Low competition window");
                
                return reasoning.join(" ‚Ä¢ ");
            }

            learn(prediction, actualResult) {
                // Update model based on actual results
                this.learningData.push({
                    prediction: prediction,
                    result: actualResult,
                    timestamp: Date.now()
                });

                // Adjust accuracy based on recent performance
                const recentData = this.learningData.slice(-10);
                const recentAccuracy = recentData.reduce((acc, data) => {
                    const correct = (data.prediction.confidence > 0.7 && data.result.success) ||
                                   (data.prediction.confidence <= 0.7 && !data.result.success);
                    return acc + (correct ? 1 : 0);
                }, 0) / recentData.length;

                this.accuracy = this.accuracy * 0.9 + recentAccuracy * 0.1; // Weighted adjustment
                
                addLearningFeed('learning', `[ML] Model accuracy updated: ${(this.accuracy * 100).toFixed(1)}% (based on ${recentData.length} recent trades)`);
            }
        }

        // Network Configuration
        const SEPOLIA_CHAIN_ID = '0xaa36a7';
        const SEPOLIA_CONFIG = {
            chainId: SEPOLIA_CHAIN_ID,
            chainName: 'Sepolia test network',
            nativeCurrency: { name: 'SepoliaETH', symbol: 'ETH', decimals: 18 },
            rpcUrls: ['https://sepolia.infura.io/v3/'],
            blockExplorerUrls: ['https://sepolia.etherscan.io/']
        };

        // Contract Addresses (Aave V3 Sepolia)
        const AAVE_POOL = '0x6Ae43d3271ff6888e7Fc43Fd7321a503ff738951';
        const USDC_ADDRESS = '0x94a9D9AC8a22534E3FaCa9F4e7F2E2cf85d5E4C8';

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            mlModel = new FlashLoanPredictor();
            addLearningFeed('learning', '[SYSTEM] AI Prediction Engine initialized');
            checkMetaMask();
            updateMLStats();
        });

        function checkMetaMask() {
            if (typeof window.ethereum !== 'undefined') {
                addLearningFeed('learning', '[SYSTEM] MetaMask detected, ready for connection');
                checkExistingConnection();
            } else {
                document.getElementById('connection-status').textContent = '‚ùå MetaMask Required';
                addLearningFeed('failure', '[ERROR] MetaMask not found - Install MetaMask extension');
            }
        }

        async function checkExistingConnection() {
            try {
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                if (accounts.length > 0) {
                    userAccount = accounts[0];
                    await handleConnection();
                }
            } catch (error) {
                console.log('No existing connection');
            }
        }

        async function connectWallet() {
            try {
                document.getElementById('connect-btn').textContent = 'üîÑ Connecting...';
                document.getElementById('connect-btn').disabled = true;

                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });

                userAccount = accounts[0];
                await handleConnection();

            } catch (error) {
                addLearningFeed('failure', `[ERROR] Connection failed: ${error.message}`);
                document.getElementById('connect-btn').textContent = 'ü¶ä Connect MetaMask';
                document.getElementById('connect-btn').disabled = false;
            }
        }

        async function handleConnection() {
            try {
                // Check network
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                
                if (chainId !== SEPOLIA_CHAIN_ID) {
                    await switchToSepolia();
                    return;
                }

                // Get balance
                const balance = await window.ethereum.request({
                    method: 'eth_getBalance',
                    params: [userAccount, 'latest']
                });

                const ethBalance = parseFloat(parseInt(balance, 16) / Math.pow(10, 18));
                tradingStats.startingBalance = ethBalance;
                tradingStats.currentBalance = ethBalance;

                // Update UI
                isConnected = true;
                document.getElementById('connection-status').textContent = 'üü¢ Connected';
                document.getElementById('user-address').textContent = userAccount;
                document.getElementById('eth-balance').textContent = ethBalance.toFixed(4);
                
                // Hide connection section, show dashboard
                document.getElementById('connect-section').style.display = 'none';
                document.getElementById('wallet-info').style.display = 'block';
                document.getElementById('main-dashboard').style.display = 'block';

                addLearningFeed('success', `[WALLET] Connected: ${userAccount.slice(0, 8)}... | Balance: ${ethBalance.toFixed(4)} ETH`);
                addLearningFeed('learning', '[AI] Initializing market analysis...');
                
                // Start market monitoring
                startMarketMonitoring();

            } catch (error) {
                addLearningFeed('failure', `[ERROR] Setup failed: ${error.message}`);
            }
        }

        async function switchToSepolia() {
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: SEPOLIA_CHAIN_ID }],
                });
                await handleConnection();
            } catch (error) {
                if (error.code === 4902) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [SEPOLIA_CONFIG],
                        });
                        await handleConnection();
                    } catch (addError) {
                        addLearningFeed('failure', '[ERROR] Please add Sepolia network manually to MetaMask');
                    }
                }
            }
        }

        function startMarketMonitoring() {
            // Update market conditions every 10 seconds
            setInterval(updateMarketConditions, 10000);
            
            // Generate predictions every 30 seconds
            setInterval(generatePredictions, 30000);
            
            // Initial calls
            updateMarketConditions();
            setTimeout(generatePredictions, 3000);
        }

        async function updateMarketConditions() {
            try {
                // Get current gas price
                const gasPrice = await window.ethereum.request({ method: 'eth_gasPrice' });
                const gasPriceGwei = parseInt(gasPrice, 16) / Math.pow(10, 9);
                
                document.getElementById('gas-price').textContent = `${gasPriceGwei.toFixed(1)} Gwei`;
                
                // Simulate market volatility and liquidity
                const volatility = (Math.random() * 0.15 + 0.05) * 100; // 5-20%
                const liquidity = Math.random() * 40 + 60; // 60-100%
                
                document.getElementById('market-volatility').textContent = `${volatility.toFixed(1)}%`;
                document.getElementById('liquidity-score').textContent = `${liquidity.toFixed(0)}/100`;
                
            } catch (error) {
                console.error('Market update failed:', error);
            }
        }

        function generatePredictions() {
            if (!isConnected) return;
            
            // Clear existing predictions
            const container = document.getElementById('predictions-container');
            container.innerHTML = '';
            
            // Generate 2-4 opportunities
            const numOpportunities = Math.floor(Math.random() * 3) + 2;
            
            for (let i = 0; i < numOpportunities; i++) {
                setTimeout(() => {
                    generateSinglePrediction();
                }, i * 1000);
            }
        }

        function generateSinglePrediction() {
            const pairs = ['ETH/USDC', 'BTC/USDT', 'LINK/ETH', 'UNI/USDC', 'AAVE/ETH'];
            const pair = pairs[Math.floor(Math.random() * pairs.length)];
            
            const opportunity = {
                pair: pair,
                amount: Math.floor(Math.random() * 200000 + 50000), // $50K-250K
                spread: Math.random() * 2000 + 200, // $200-2200 potential profit
                gasPrice: parseInt(document.getElementById('gas-price').textContent) || 20,
                timestamp: Date.now()
            };
            
            const prediction = mlModel.analyzeOpportunity(opportunity);
            tradingStats.predictionsMade++;
            
            displayPrediction(opportunity, prediction);
            
            addLearningFeed('learning', 
                `[AI] Analyzed ${pair}: ${prediction.confidence.toFixed(1)}% confidence ‚Üí ${prediction.recommendation}`
            );
        }

        function displayPrediction(opportunity, prediction) {
            const container = document.getElementById('predictions-container');
            
            const predictionCard = document.createElement('div');
            predictionCard.className = `prediction-card ${getConfidenceClass(prediction.confidence)}`;
            
            const estimatedProfit = opportunity.spread - (opportunity.amount * 0.0009) - 25; // minus fees and gas
            
            predictionCard.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div style="font-size: 18px; font-weight: 700;">üíé ${opportunity.pair}</div>
                    <div style="font-size: 16px; font-weight: 700; color: ${getConfidenceColor(prediction.confidence)};">
                        ${(prediction.confidence * 100).toFixed(1)}% ${prediction.recommendation}
                    </div>
                </div>
                
                <div class="prediction-stats">
                    <div class="stat-box">
                        <div class="stat-value">$${opportunity.amount.toLocaleString()}</div>
                        <div class="stat-label">Flash Loan</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" style="color: ${estimatedProfit > 0 ? '#00ff88' : '#ff6b6b'};">
                            $${estimatedProfit.toFixed(0)}
                        </div>
                        <div class="stat-label">Est. Profit</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${(prediction.confidence * 100).toFixed(0)}%</div>
                        <div class="stat-label">AI Score</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">
                            ${Math.floor((Date.now() - opportunity.timestamp) / 1000) + 30}s
                        </div>
                        <div class="stat-label">Time Left</div>
                    </div>
                </div>
                
                <div style="margin-top: 15px; font-size: 12px; opacity: 0.8;">
                    <strong>AI Analysis:</strong> ${prediction.reasoning}
                </div>
                
                <div style="margin-top: 15px; display: flex; gap: 10px;">
                    <button class="control-btn" style="flex: 1; padding: 10px;" onclick="executePrediction('${opportunity.pair}', ${opportunity.amount}, ${estimatedProfit}, ${prediction.confidence})">
                        ‚ö° Execute Trade
                    </button>
                    <button class="control-btn" style="flex: 1; padding: 10px; opacity: 0.7;" onclick="skipPrediction('${opportunity.pair}')">
                        ‚è≠Ô∏è Skip
                    </button>
                </div>
            `;
            
            predictionCard.onclick = () => {
                if (prediction.confidence > 0.7) {
                    executePrediction(opportunity.pair, opportunity.amount, estimatedProfit, prediction.confidence);
                }
            };
            
            container.appendChild(predictionCard);
            
            // Remove after 45 seconds
            setTimeout(() => {
                if (predictionCard.parentNode) {
                    predictionCard.remove();
                }
            }, 45000);
        }

        function getConfidenceClass(confidence) {
            if (confidence >= 0.7) return 'high-confidence';
            if (confidence >= 0.5) return 'medium-confidence';
            return 'low-confidence';
        }

        function getConfidenceColor(confidence) {
            if (confidence >= 0.7) return '#00ff88';
            if (confidence >= 0.5) return '#ffd700';
            return '#ff6b6b';
        }

        async function executePrediction(pair, amount, estimatedProfit, confidence) {
            if (!confirm(`üöÄ EXECUTE FLASH LOAN\n\nPair: ${pair}\nAmount: $${amount.toLocaleString()}\nEstimated Profit: $${estimatedProfit.toFixed(2)}\nAI Confidence: ${(confidence * 100).toFixed(1)}%\n\nProceed with REAL transaction?`)) {
                return;
            }

            try {
                addLearningFeed('learning', `[EXECUTE] Initiating flash loan: ${pair} | $${amount.toLocaleString()} | AI: ${(confidence * 100).toFixed(1)}%`);
                
                // Simulate flash loan execution
                const gasPrice = await window.ethereum.request({ method: 'eth_gasPrice' });
                const gasCost = (200000 * parseInt(gasPrice, 16)) / Math.pow(10, 18); // Estimated gas
                
                // Send actual transaction (simplified for demo)
                const transaction = await window.ethereum.request({
                    method: 'eth_sendTransaction',
                    params: [{
                        from: userAccount,
                        to: userAccount, // Self-transaction for demo
                        value: '0x0',
                        gas: '0x5208'
                    }]
                });
                
                addLearningFeed('success', `[TX] Transaction sent: ${transaction.slice(0, 10)}...`);
                
                // Simulate outcome based on confidence
                const success = Math.random() < confidence;
                const actualProfit = success ? 
                    estimatedProfit * (0.8 + Math.random() * 0.4) : // 80-120% of estimated
                    -gasCost * 1800; // Convert ETH to USD
                
                // Update statistics
                tradingStats.totalTrades++;
                if (success) {
                    tradingStats.successfulTrades++;
                    tradingStats.totalProfit += actualProfit;
                } else {
                    tradingStats.failedTrades++;
                    tradingStats.totalProfit += actualProfit; // Negative value
                }
                
                // ML Learning
                mlModel.learn(
                    { confidence: confidence }, 
                    { success: success, profit: actualProfit }
                );
                
                // Update UI
                updateTradingStats();
                
                const outcome = success ? 'SUCCESS' : 'FAILED';
                const color = success ? 'success' : 'failure';
                
                addLearningFeed(color, 
                    `[${outcome}] ${pair} flash loan: ${success ? '+' : ''}$${actualProfit.toFixed(2)} | Gas: $${(gasCost * 1800).toFixed(2)}`
                );
                
            } catch (error) {
                addLearningFeed('failure', `[ERROR] Trade execution failed: ${error.message}`);
            }
        }

        function skipPrediction(pair) {
            addLearningFeed('learning', `[SKIP] Skipped ${pair} opportunity (manual decision)`);
        }

        function startAITrading() {
            if (!isConnected) return;
            
            aiTradingActive = !aiTradingActive;
            const btn = document.getElementById('ai-trading-btn');
            
            if (aiTradingActive) {
                btn.textContent = '‚è∏Ô∏è Pause AI Trading';
                btn.style.background = 'linear-gradient(45deg, #ff6b6b, #ff4757)';
                addLearningFeed('success', '[AI] Automated trading ACTIVATED - AI will execute high-confidence trades');
                
                // Auto-execute high confidence trades
                startAutoTrading();
            } else {
                btn.textContent = 'üöÄ Start AI Trading';
                btn.style.background = 'linear-gradient(45deg, #00d4ff, #00ff88)';
                addLearningFeed('learning', '[AI] Automated trading PAUSED - Manual mode enabled');
            }
        }

        function startAutoTrading() {
            const autoTrade = setInterval(() => {
                if (!aiTradingActive) {
                    clearInterval(autoTrade);
                    return;
                }
                
                // Check for high-confidence opportunities
                const predictions = document.querySelectorAll('.prediction-card.high-confidence');
                if (predictions.length > 0 && Math.random() < 0.3) { // 30% chance to auto-execute
                    const executeBtn = predictions[0].querySelector('button');
                    if (executeBtn) {
                        executeBtn.click();
                    }
                }
            }, 15000); // Check every 15 seconds
        }

        function scanMarket() {
            addLearningFeed('learning', '[SCAN] Forcing comprehensive market scan...');
            generatePredictions();
        }

        function stopTrading() {
            aiTradingActive = false;
            document.getElementById('ai-trading-btn').textContent = 'üöÄ Start AI Trading';
            document.getElementById('ai-trading-btn').style.background = 'linear-gradient(45deg, #00d4ff, #00ff88)';
            addLearningFeed('failure', '[STOP] EMERGENCY STOP - All trading halted');
        }

        function updateTradingStats() {
            document.getElementById('total-profit').textContent = `$${tradingStats.totalProfit.toFixed(2)}`;
            document.getElementById('total-profit').className = `profit-amount ${tradingStats.totalProfit >= 0 ? 'profit-positive' : 'profit-negative'}`;
            
            document.getElementById('successful-trades').textContent = tradingStats.successfulTrades;
            document.getElementById('failed-trades').textContent = tradingStats.failedTrades;
            
            const winRate = tradingStats.totalTrades > 0 ? 
                (tradingStats.successfulTrades / tradingStats.totalTrades * 100).toFixed(1) : 0;
            document.getElementById('win-rate').textContent = `${winRate}%`;
            
            updateMLStats();
        }

        function updateMLStats() {
            document.getElementById('ml-accuracy').textContent = `${(mlModel?.accuracy * 100 || 65).toFixed(1)}%`;
            document.getElementById('predictions-made').textContent = tradingStats.predictionsMade;
        }

        function addLearningFeed(type, message) {
            const feed = document.getElementById('learning-feed-content');
            const timestamp = new Date().toLocaleTimeString();
            
            const feedItem = document.createElement('div');
            feedItem.className = `feed-item feed-${type}`;
            feedItem.textContent = `[${timestamp}] ${message}`;
            
            feed.insertBefore(feedItem, feed.firstChild);
            
            // Keep only latest 20 items
            while (feed.children.length > 20) {
                feed.removeChild(feed.lastChild);
            }
        }

        // MetaMask Event Listeners
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length === 0) location.reload();
            });
            
            window.ethereum.on('chainChanged', (chainId) => {
                if (chainId !== SEPOLIA_CHAIN_ID) {
                    addLearningFeed('failure', '[NETWORK] Wrong network - Please switch to Sepolia');
                }
            });
        }
    </script>
</body>
</html>
