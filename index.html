<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Flash Loan Test - Sepolia</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #0a0a0a;
            color: #00ff00;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #00ff00;
            border-radius: 10px;
            padding: 30px;
        }
        
        h1 {
            text-align: center;
            color: #00ffff;
            text-shadow: 0 0 10px #00ffff;
            margin-bottom: 30px;
        }
        
        .status {
            background: rgba(0, 255, 0, 0.1);
            border: 1px solid #00ff00;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
            text-align: center;
        }
        
        .error {
            background: rgba(255, 0, 0, 0.1);
            border: 1px solid #ff0000;
            color: #ff0000;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
        }
        
        button {
            background: linear-gradient(45deg, #00ff00, #00ffff);
            border: none;
            color: #000;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
            transition: all 0.3s ease;
            width: 100%;
        }
        
        button:hover {
            transform: scale(1.02);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        input {
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid #00ff00;
            color: #00ff00;
            padding: 10px;
            margin: 5px 0;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            width: 100%;
            box-sizing: border-box;
        }
        
        .info-box {
            background: rgba(0, 0, 255, 0.1);
            border: 1px solid #0099ff;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
            font-size: 14px;
        }
        
        .log {
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #333;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
            font-size: 12px;
        }
        
        .log-entry {
            margin: 5px 0;
            padding: 3px 0;
        }
        
        .log-success { color: #00ff00; }
        .log-error { color: #ff0000; }
        .log-info { color: #00ffff; }
        
        .address {
            word-break: break-all;
            font-size: 11px;
            color: #888;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚ö° SIMPLE FLASH LOAN TEST</h1>
        
        <div class="info-box">
            <strong>üß™ TESTNET ONLY:</strong> This is a simplified test to verify basic flash loan functionality.
            <br><strong>Network:</strong> Sepolia Testnet
            <br><strong>Risk:</strong> Only gas costs (testnet ETH)
        </div>

        <!-- Connection Status -->
        <div class="status" id="connection-status">
            üîå Status: Not Connected
        </div>

        <!-- Wallet Info -->
        <div id="wallet-info" style="display: none;">
            <div class="info-box">
                <strong>üìç Connected Wallet:</strong><br>
                <span id="user-address" class="address"></span><br>
                <strong>Balance:</strong> <span id="eth-balance">0</span> ETH<br>
                <strong>Network:</strong> <span id="network-name">-</span>
            </div>
        </div>

        <!-- Connect Button -->
        <button onclick="connectWallet()" id="connect-btn">
            ü¶ä Connect MetaMask
        </button>

        <!-- Flash Loan Test -->
        <div id="flash-loan-section" style="display: none;">
            <div class="info-box">
                <strong>üî• Simple Flash Loan Test</strong><br>
                This will attempt a basic flash loan using existing Aave contracts.<br>
                <strong>Test Amount:</strong> 100 USDC<br>
                <strong>Strategy:</strong> Borrow and immediately repay (minimal test)
            </div>
            
            <button onclick="testFlashLoan()" id="test-btn">
                ‚ö° Test Flash Loan (100 USDC)
            </button>
            
            <button onclick="estimateGas()" id="estimate-btn">
                ‚õΩ Estimate Gas Cost
            </button>
        </div>

        <!-- Transaction Log -->
        <div class="log" id="transaction-log">
            <div class="log-entry log-info">[SYSTEM] Simple Flash Loan Test initialized</div>
        </div>
    </div>

    <script>
        // Global variables
        let userAccount = null;
        let isConnected = false;

        // Network Configuration
        const SEPOLIA_CHAIN_ID = '0xaa36a7';
        const AAVE_POOL_ADDRESS = '0x6Ae43d3271ff6888e7Fc43Fd7321a503ff738951';
        const USDC_ADDRESS = '0x94a9D9AC8a22534E3FaCa9F4e7F2E2cf85d5E4C8';

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            log('info', 'System initialized');
            checkMetaMask();
        });

        function checkMetaMask() {
            if (typeof window.ethereum !== 'undefined') {
                log('success', 'MetaMask detected');
                checkExistingConnection();
            } else {
                log('error', 'MetaMask not found - Please install MetaMask');
                document.getElementById('connection-status').innerHTML = 
                    '‚ùå Status: MetaMask Not Found';
            }
        }

        async function checkExistingConnection() {
            try {
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                if (accounts.length > 0) {
                    userAccount = accounts[0];
                    isConnected = true;
                    await updateWalletInfo();
                    log('success', `Auto-connected: ${userAccount.slice(0, 8)}...`);
                }
            } catch (error) {
                log('info', 'No existing connection');
            }
        }

        async function connectWallet() {
            try {
                log('info', 'Connecting to MetaMask...');
                document.getElementById('connect-btn').textContent = 'üîÑ Connecting...';
                document.getElementById('connect-btn').disabled = true;

                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });

                if (accounts.length === 0) {
                    throw new Error('No accounts found');
                }

                userAccount = accounts[0];
                isConnected = true;
                
                // Check network
                const chainId = await window.ethereum.request({
                    method: 'eth_chainId'
                });

                if (chainId !== SEPOLIA_CHAIN_ID) {
                    await switchToSepolia();
                } else {
                    await updateWalletInfo();
                }

            } catch (error) {
                log('error', `Connection failed: ${error.message}`);
                resetConnectionButton();
            }
        }

        async function switchToSepolia() {
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: SEPOLIA_CHAIN_ID }],
                });
                await updateWalletInfo();
            } catch (error) {
                if (error.code === 4902) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: SEPOLIA_CHAIN_ID,
                                chainName: 'Sepolia test network',
                                nativeCurrency: {
                                    name: 'SepoliaETH',
                                    symbol: 'ETH',
                                    decimals: 18
                                },
                                rpcUrls: ['https://sepolia.infura.io/v3/9aa3d95b3bc440fa88ea12eaa4456161'],
                                blockExplorerUrls: ['https://sepolia.etherscan.io/']
                            }],
                        });
                        await updateWalletInfo();
                    } catch (addError) {
                        log('error', 'Failed to add Sepolia network');
                        resetConnectionButton();
                    }
                } else {
                    log('error', 'Please switch to Sepolia manually');
                    resetConnectionButton();
                }
            }
        }

        async function updateWalletInfo() {
            try {
                // Get balance
                const balance = await window.ethereum.request({
                    method: 'eth_getBalance',
                    params: [userAccount, 'latest']
                });
                
                const ethBalance = parseFloat(parseInt(balance, 16) / Math.pow(10, 18)).toFixed(4);
                
                // Update UI
                document.getElementById('user-address').textContent = userAccount;
                document.getElementById('eth-balance').textContent = ethBalance;
                document.getElementById('network-name').textContent = 'Sepolia Testnet';
                
                document.getElementById('connection-status').innerHTML = '‚úÖ Status: Connected to Sepolia';
                document.getElementById('connect-btn').textContent = '‚úÖ Wallet Connected';
                document.getElementById('connect-btn').disabled = true;
                
                document.getElementById('wallet-info').style.display = 'block';
                document.getElementById('flash-loan-section').style.display = 'block';
                
                log('success', `Connected successfully - Balance: ${ethBalance} ETH`);
                
                if (parseFloat(ethBalance) < 0.01) {
                    log('error', 'Low ETH balance - Get testnet ETH from faucet');
                }

            } catch (error) {
                log('error', `Failed to get wallet info: ${error.message}`);
                resetConnectionButton();
            }
        }

        function resetConnectionButton() {
            document.getElementById('connect-btn').textContent = 'ü¶ä Connect MetaMask';
            document.getElementById('connect-btn').disabled = false;
            isConnected = false;
            userAccount = null;
        }

        async function estimateGas() {
            if (!isConnected) {
                alert('Please connect your wallet first!');
                return;
            }

            try {
                log('info', 'Estimating gas costs...');
                
                // Get current gas price
                const gasPrice = await window.ethereum.request({
                    method: 'eth_gasPrice'
                });
                
                const gasPriceGwei = parseInt(gasPrice, 16) / Math.pow(10, 9);
                log('info', `Current gas price: ${gasPriceGwei.toFixed(2)} Gwei`);
                
                // Estimate gas for simple transaction
                try {
                    const gasEstimate = await window.ethereum.request({
                        method: 'eth_estimateGas',
                        params: [{
                            from: userAccount,
                            to: userAccount,
                            value: '0x0'
                        }]
                    });
                    
                    const gasAmount = parseInt(gasEstimate, 16);
                    const gasCost = (gasAmount * parseInt(gasPrice, 16)) / Math.pow(10, 18);
                    
                    log('success', `‚úÖ Gas estimation successful:`);
                    log('info', `‚Ä¢ Simple transaction: ${gasAmount.toLocaleString()} gas`);
                    log('info', `‚Ä¢ Cost: ${gasCost.toFixed(6)} ETH (‚âà${(gasCost * 1800).toFixed(3)})`);
                    log('info', `‚Ä¢ Flash loan would need ~200,000 gas`);
                    log('info', `‚Ä¢ Flash loan cost: ~${((200000 * parseInt(gasPrice, 16)) / Math.pow(10, 18)).toFixed(6)} ETH`);
                    
                } catch (gasError) {
                    log('error', `Gas estimation failed: ${gasError.message}`);
                    
                    // Fallback estimation
                    const basicGasCost = (21000 * parseInt(gasPrice, 16)) / Math.pow(10, 18);
                    log('info', `Fallback estimate - Basic transaction: ${basicGasCost.toFixed(6)} ETH`);
                }
                
                // Check if user has enough ETH
                const balance = await window.ethereum.request({
                    method: 'eth_getBalance',
                    params: [userAccount, 'latest']
                });
                
                const ethBalance = parseFloat(parseInt(balance, 16) / Math.pow(10, 18));
                
                if (ethBalance < 0.001) {
                    log('error', '‚ö†Ô∏è Low ETH balance for gas fees');
                    log('info', 'Get testnet ETH from:');
                    
                    // Add clickable faucet links
                    const logElement = document.getElementById('transaction-log');
                    const faucetEntry = document.createElement('div');
                    faucetEntry.className = 'log-entry log-info';
                    faucetEntry.innerHTML = `[${new Date().toLocaleTimeString()}] <a href="https://sepoliafaucet.com/" target="_blank" style="color: #00ffff; text-decoration: underline;">SepoliaFaucet.com</a>`;
                    logElement.insertBefore(faucetEntry, logElement.firstChild);
                    
                    const faucetEntry2 = document.createElement('div');
                    faucetEntry2.className = 'log-entry log-info';
                    faucetEntry2.innerHTML = `[${new Date().toLocaleTimeString()}] <a href="https://faucets.chain.link/sepolia" target="_blank" style="color: #00ffff; text-decoration: underline;">Chainlink Faucet</a>`;
                    logElement.insertBefore(faucetEntry2, logElement.firstChild);
                    
                } else {
                    log('success', `‚úÖ Sufficient balance: ${ethBalance.toFixed(4)} ETH`);
                }
                
            } catch (error) {
                log('error', `Gas estimation failed: ${error.message}`);
                console.error('Gas estimation error:', error);
            }
        }

        async function testFlashLoan() {
            if (!isConnected) {
                alert('Please connect your wallet first!');
                return;
            }

            if (!confirm('‚ö†Ô∏è TEST TRANSACTION ‚ö†Ô∏è\n\nThis will send a simple test transaction to verify the connection works.\n\nYou will pay a small gas fee (~0.0005 ETH).\n\nProceed?')) {
                return;
            }

            try {
                log('info', 'üö® TESTING BLOCKCHAIN CONNECTION üö®');
                document.getElementById('test-btn').textContent = '‚è≥ Testing...';
                document.getElementById('test-btn').disabled = true;

                // Get current gas price
                const gasPrice = await window.ethereum.request({
                    method: 'eth_gasPrice'
                });

                log('info', `Current gas price: ${parseInt(gasPrice, 16).toLocaleString()} wei`);
                log('info', `From account: ${userAccount.slice(0, 8)}...`);

                // Send a simple self-transaction (most likely to succeed)
                const transaction = await window.ethereum.request({
                    method: 'eth_sendTransaction',
                    params: [{
                        from: userAccount,
                        to: userAccount, // Send to self
                        value: '0x0', // 0 ETH
                        gas: '0x5208', // 21000 gas (minimum)
                        gasPrice: gasPrice
                    }]
                });

                log('success', `‚úÖ Test transaction sent: ${transaction}`);
                
                // Create clickable Etherscan link
                const etherscanUrl = `https://sepolia.etherscan.io/tx/${transaction}`;
                log('info', `Track on Etherscan:`);
                
                // Add clickable link to log
                const logElement = document.getElementById('transaction-log');
                const linkEntry = document.createElement('div');
                linkEntry.className = 'log-entry log-info';
                linkEntry.innerHTML = `[${new Date().toLocaleTimeString()}] <a href="${etherscanUrl}" target="_blank" style="color: #00ffff; text-decoration: underline;">${etherscanUrl}</a>`;
                logElement.insertBefore(linkEntry, logElement.firstChild);
                
                log('info', 'Waiting for confirmation...');

                // Monitor transaction with better error handling
                let receipt = null;
                let attempts = 0;
                const maxAttempts = 30; // 1.5 minutes
                
                while (attempts < maxAttempts && !receipt) {
                    try {
                        receipt = await window.ethereum.request({
                            method: 'eth_getTransactionReceipt',
                            params: [transaction]
                        });
                        
                        if (receipt) {
                            break;
                        }
                    } catch (e) {
                        console.log('Receipt check failed:', e.message);
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 3000));
                    attempts++;
                    
                    if (attempts % 5 === 0) {
                        log('info', `Still waiting... (${attempts * 3}s) - Check Etherscan link above`);
                    }
                }

                if (receipt) {
                    if (receipt.status === '0x1') {
                        log('success', 'üéâ TEST TRANSACTION SUCCESSFUL! üéâ');
                        log('success', `Block: ${parseInt(receipt.blockNumber, 16)}`);
                        log('success', `Gas used: ${parseInt(receipt.gasUsed, 16).toLocaleString()}`);
                        
                        const gasUsed = parseInt(receipt.gasUsed, 16);
                        const gasCost = (gasUsed * parseInt(gasPrice, 16)) / Math.pow(10, 18);
                        log('info', `Total cost: ${gasCost.toFixed(6)} ETH`);
                        
                        log('success', '‚úÖ Your wallet and Sepolia connection work perfectly!');
                        log('info', 'Next: We can try more complex transactions');
                        
                    } else {
                        log('error', '‚ùå Transaction failed on blockchain');
                        log('error', 'Check the Etherscan link above for details');
                    }
                } else {
                    log('error', '‚ö†Ô∏è Transaction confirmation timeout');
                    log('info', 'Transaction might still be pending - check Etherscan link above');
                }

            } catch (error) {
                log('error', `Transaction failed: ${error.message}`);
                
                if (error.code === 4001) {
                    log('error', 'Transaction rejected by user');
                } else if (error.message.includes('insufficient funds')) {
                    log('error', 'Insufficient ETH for gas fees');
                    log('info', 'Try getting more testnet ETH from: https://sepoliafaucet.com/');
                } else if (error.message.includes('gas')) {
                    log('error', 'Gas-related error - network might be congested');
                } else {
                    log('error', 'Unknown error - check browser console for details');
                    console.error('Full error:', error);
                }
            }

            document.getElementById('test-btn').textContent = '‚ö° Test Flash Loan (100 USDC)';
            document.getElementById('test-btn').disabled = false;
        }

        function log(type, message) {
            const logElement = document.getElementById('transaction-log');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${timestamp}] ${message}`;
            
            logElement.insertBefore(entry, logElement.firstChild);
            
            // Keep only last 30 entries
            while (logElement.children.length > 30) {
                logElement.removeChild(logElement.lastChild);
            }
            
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // MetaMask event listeners
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', function (accounts) {
                if (accounts.length === 0) {
                    log('info', 'Wallet disconnected');
                    location.reload();
                } else if (accounts[0] !== userAccount) {
                    log('info', 'Account changed');
                    location.reload();
                }
            });
            
            window.ethereum.on('chainChanged', function (chainId) {
                log('info', `Network changed: ${chainId}`);
                if (chainId !== SEPOLIA_CHAIN_ID) {
                    log('error', 'Wrong network! Please switch to Sepolia');
                }
                location.reload();
            });
        }
    </script>
</body>
</html>
